# WebVM 開発進捗

## 現在の進捗状況

### 完了した機能

#### 1. カーネル基盤
- [x] WebAssemblyカーネルの基本構造
- [x] WASI システムコールの実装
  - [x] `fd_write` (stdout/stderr)
  - [x] `fd_read` (stdin)
  - [x] `proc_exit`
  - [x] `clock_time_get`
- [x] Linux風のディレクトリ構造
  - `/kernel/init/` - 初期化
  - `/kernel/mm/` - メモリ管理
  - `/kernel/fs/` - ファイルシステム
  - `/kernel/drivers/` - デバイスドライバ
  - `/kernel/shell/` - シェル
  - `/kernel/lib/` - ライブラリ関数

#### 2. メモリ管理
- [x] 基本的なメモリアロケータ (`kmalloc`/`kfree`)
- [x] 32MBの静的メモリプール
- [x] SharedArrayBuffer対応 (128MB) 

#### 3. ファイルシステム
- [x] VFS (Virtual File System) の基本実装
- [x] マウントポイント管理
- [x] IndexedDB バックエンド実装
- [x] 実際のファイル操作 (create, read, write, delete)
- [x] ディレクトリ操作 (mkdir, rmdir, ls)
- [x] ファイル統計情報 (stat)
- [x] パス正規化と作業ディレクトリ管理
- [x] 疑似ファイルシステム (スタブ) 
  - `/proc/version`
  - `/etc/passwd`

#### 4. デバイスドライバ
- [x] コンソールドライバ
- [x] ドライバ登録システム
- [x] ANSI エスケープシーケンス対応

#### 5. シェル
- [x] 基本的なコマンドラインインターフェース
- [x] ビルトインコマンド
  - `help` - ヘルプ表示
  - `clear` - 画面クリア
  - `echo` - テキスト出力 (リダイレクト対応)
  - `ps` - プロセス一覧
  - `kill` - プロセス終了
  - `spawn` - テストプロセス生成
  - `ls` - ファイル一覧
  - `cat` - ファイル表示
  - `mkdir` - ディレクトリ作成
  - `rmdir` - ディレクトリ削除
  - `rm` - ファイル削除
  - `touch` - ファイル作成
  - `pwd` - 現在のディレクトリ表示
  - `cd` - ディレクトリ移動
  - `about` - システム情報
  - `exit` - 終了

#### 6. プロセス管理
- [x] プロセステーブルの実装
  - [x] プロセス制御ブロック (PCB)
  - [x] 最大64プロセスのサポート
  - [x] プロセス状態管理 (UNUSED, INIT, READY, RUNNING, WAITING, ZOMBIE, TERMINATED)
- [x] `posix_spawn` 実装 (fork()の代替)
- [x] プロセススケジューラー
  - [x] ラウンドロビンスケジューリング
  - [x] レディキュー管理
  - [x] 協調的マルチタスキング (WebAssembly制約)
- [x] プロセス間通信 (IPC)
  - [x] メッセージパッシング
  - [x] パイプ実装
  - [x] ブロッキング/ノンブロッキング操作

#### 7. GUI/ブラウザ統合
- [x] ターミナルウィンドウ UI
- [x] ウィンドウマネージャー (ドラッグ、最大化) 
- [x] stdin/stdout のブラウザ統合
- [x] コマンドハンドラー経由の入力処理

#### 8. ビルドシステム
- [x] Ninja ビルドシステム
- [x] TypeScript/JavaScript モジュール構造
- [x] CSS分離

#### 9. 最近の改善
- [x] ファイルI/O無限ループ問題の解決
- [x] EOF (End of File) 処理の実装
- [x] グローバルキャッシュによる読み取り状態管理
- [x] echo コマンドのリダイレクト解析修正
- [x] ファイル書き込みバッファリング実装
- [x] デバッグ出力の完全削除とコードクリーンアップ

## 🚧 やること

### 高優先度

#### 1. ファイルシステム機能拡張
- [ ] ファイルパーミッション管理の完全実装
- [ ] シンボリックリンク対応
- [ ] ファイルシステムキャッシュ最適化
- [ ] 大容量ファイル対応

#### 2. ネットワーク
- [ ] ソケット API の実装
- [ ] WebSocket ベースのネットワーク層
- [ ] 基本的なネットワークコマンド (ping, wget 相当) 

### 中優先度

#### 3. シェル拡張
- [ ] パイプ機能
- [x] リダイレクト (echo > file 実装済み)
- [ ] 環境変数
- [ ] ジョブコントロール
- [ ] コマンド履歴
- [ ] タブ補完

#### 4. デバイスドライバ
- [ ] キーボードドライバ (詳細な入力処理) 
- [ ] マウスドライバ
- [ ] フレームバッファドライバ (グラフィックス) 

#### 5. 標準ユーティリティ
- [ ] 基本的なUNIXコマンド群
  - [ ] `cp`, `mv`
  - [x] `rm` (実装済み)
  - [ ] `grep`, `sed`, `awk`
  - [ ] `vi` または `nano` エディタ

### 低優先度

#### 6. 高度な機能
- [ ] マルチスレッド (pthread) 
- [ ] 共有ライブラリ
- [ ] デバッガー
- [ ] パッケージマネージャー

#### 7. パフォーマンス最適化
- [ ] メモリ管理の最適化
- [ ] ファイルシステムキャッシュ
- [ ] コンパイラ最適化

## 既知の問題

1. **メモリ管理**
   - `mm_stats` 構造体が未定義 (`kernel/mm/memory.c:134`) 
   - `kmalloc` 実装が不完全 (`kernel/lib/string.c:79`) 

2. **ファイルシステム**
   - procfs の完全な実装が必要 (`kernel/fs/vfs.c:183`) 

3. **標準ライブラリ**
   - 数値変換が未実装 (`kernel/drivers/console.c:111`) 

4. **ドライバ**
   - 追加ドライバが必要 (`kernel/drivers/drivers.c:69-72`) 

## 技術的な詳細

### メモリレイアウト
- カーネル最大メモリ: 128MB (134217728 bytes)
- メモリプール: 32MB
- スタックサイズ: 1MB
- WebAssembly ページ: 2048 (64KB/ページ)

### ビルド要件
- clang (wasm32 ターゲット)
- wasm-ld
- ninja
- pnpm
- TypeScript

### アーキテクチャ
1. **カーネル層** (C/WebAssembly)
2. **システムライブラリ層** (TypeScript)
3. **GUI層** (HTML/CSS/JavaScript)

## 次のステップ

1. ネットワーク機能の実装 (WebSocket ベースソケットAPI)
2. プロセス管理の高度な機能 (シグナル、wait/waitpid)
3. シェルのパイプ機能実装
4. 高度なUNIXコマンドの実装 (cp, mv, grep など)
5. テストスイートの作成
6. パフォーマンス最適化

## 最新の成果 (2025/06/21)

WebVMは基本的なUnix風OSとしての機能を実現しました：

### ✨ 動作するファイルシステム
- IndexedDBによる永続化ストレージ
- 完全なディレクトリ・ファイル操作
- POSIX風のファイルAPI

### ✨ 実用的なシェル環境
- 15個以上のビルトインコマンド
- ファイルリダイレクト対応
- 作業ディレクトリ管理

### ✨ 安定したプロセス管理
- 協調的マルチタスキング
- IPC (プロセス間通信)
- プロセステーブル管理
